rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {
    // 관리자 확인 함수
    function isAdmin() {
      return request.auth != null && request.auth.token.email == 'kidcap1001@naver.com';
    }

    // 유저 문서 규칙
    match /users/{userId} {
      allow read, write: if request.auth != null && request.auth.uid == userId;
      allow read, update: if isAdmin();
    }
    
    // 유저 목록 조회를 위한 규칙
    match /users {
      allow list: if isAdmin();
    }

    // 메시지(문의사항) 규칙
    match /messages/{messageId} {
      // 생성 시점에는 데이터가 없으므로 request.auth 확인만 함
      allow create: if request.auth != null;
      // 본인의 메시지만 읽기 가능, 관리자는 모든 메시지 읽기 가능
      allow read: if request.auth != null && (request.auth.uid == resource.data.userId || isAdmin());
      // 관리자는 모든 필드 수정 가능, 유저는 자신의 메시지의 userRead 필드만 수정 가능
      allow update: if isAdmin() || (
        request.auth != null && 
        request.auth.uid == resource.data.userId && 
        request.resource.data.diff(resource.data).affectedKeys().hasOnly(['userRead'])
      );
      // 목록 조회
      allow list: if request.auth != null && (isAdmin() || request.query.limit <= 100); 
    }
  }
}
